name: Apex Coach AI CI & Azure Deploy

on:
  push:
    branches: [main]
  workflow_dispatch: {}

# Unified workflow combining infrastructure provisioning (azd) and static web app deployment.
# "Relaxed" behavior:
#  - Regular pushes to main only build and deploy the web app (no infra changes).
#  - Infrastructure provisioning (azd up) runs ONLY when manually triggered via workflow_dispatch.
#  - Shared build artifacts kept minimal; web build reused by deploy job.
#  - Optional verification step performs a lightweight availability check.

permissions:
  id-token: write # Required for federated Azure auth when using OIDC
  contents: read

concurrency:
  group: apexcoach-ai-ci-deploy
  cancel-in-progress: false # Allow overlapping manual infra runs; keep it relaxed.

env:
  NODE_VERSION: '22.x'
  PNPM_VERSION: '10.0.0'
  # Reference subscription from repo vars if set, else fallback constant used previously
  AZURE_SUBSCRIPTION_ID: ${{ vars.AZURE_SUBSCRIPTION_ID || '44e77ffe-2c39-4726-b6f0-2c733c7ffe78' }}

jobs:
  build-web:
    name: Build Web App
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build
        run: pnpm build

      - name: Archive build output
        if: success()
        run: |
          mkdir -p artifact
          cp -R dist artifact/dist
        # Upload artifact for downstream deploy job
      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: web-dist
          path: artifact/dist

  deploy-static:
    name: Deploy Static Web App
    runs-on: ubuntu-latest
    needs: build-web
    steps:
      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: web-dist
          path: dist

      - name: Deploy to Azure Static Web Apps
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN }}
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          action: upload
          app_location: '/'
          output_location: 'dist'
          skip_app_build: true

  verify:
    name: Verify Deployment
    runs-on: ubuntu-latest
    needs: deploy-static
    if: always()
    steps:
      - name: Check site availability
        run: |
          set -e
          curl -f -L --max-time 30 "https://apexcoach.shtrial.com" >/dev/null && echo "Site OK" || (echo "Deployment verification failed" && exit 1)

  provision-infra:
    name: Provision / Update Azure Infrastructure (Manual Only)
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    env:
      AZURE_CLIENT_ID: ${{ vars.AZURE_CLIENT_ID }}
      AZURE_TENANT_ID: ${{ vars.AZURE_TENANT_ID }}
      AZURE_SUBSCRIPTION_ID: ${{ vars.AZURE_SUBSCRIPTION_ID }}
      AZURE_CREDENTIALS: ${{ secrets.AZURE_CREDENTIALS }}
      AZURE_ALIAS: ${{ vars.AZURE_ALIAS }}
      AZURE_ENV_NAME: ${{ vars.AZURE_ENV_NAME }}
      AZURE_LOCATION: ${{ vars.AZURE_LOCATION }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install azd
        uses: Azure/setup-azd@v2

      - name: Setup Node.js (for any pre/post azd scripts)
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Azure Login (Federated)
        if: env.AZURE_CLIENT_ID != ''
        shell: pwsh
        run: |
          azd auth login `
            --client-id "$Env:AZURE_CLIENT_ID" `
            --federated-credential-provider github `
            --tenant-id "$Env:AZURE_TENANT_ID"

      - name: Azure Login (Client Secret)
        if: env.AZURE_CREDENTIALS != '' && env.AZURE_CLIENT_ID == ''
        shell: pwsh
        env:
          AZURE_CREDENTIALS: ${{ secrets.AZURE_CREDENTIALS }}
        run: |
          $info = $Env:AZURE_CREDENTIALS | ConvertFrom-Json -AsHashtable
          Write-Host "::add-mask::$($info.clientSecret)"
          azd auth login `
            --client-id "$($info.clientId)" `
            --client-secret "$($info.clientSecret)" `
            --tenant-id "$($info.tenantId)"

      - name: Provision & Deploy (azd up)
        run: azd up --no-prompt
        env:
          AZURE_ENV_NAME: ${{ vars.AZURE_ENV_NAME }}
          AZURE_LOCATION: ${{ vars.AZURE_LOCATION }}
          AZURE_SUBSCRIPTION_ID: ${{ vars.AZURE_SUBSCRIPTION_ID }}
          AZURE_ALIAS: ${{ vars.AZURE_ALIAS }}

      - name: Output Environment Info
        shell: pwsh
        run: |
          azd env get-values

  summary:
    name: Summary
    runs-on: ubuntu-latest
    needs: [build-web, deploy-static, verify]
    if: always()
    steps:
      - name: Deployment Summary
        run: |
          echo "Build, deploy, and verify steps completed."
          echo "Infra provisioning runs only on manual dispatch events."

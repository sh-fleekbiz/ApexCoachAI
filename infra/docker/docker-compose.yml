version: '3.9'

services:
  search:
    build:
      context: ../..
      dockerfile: apps/backend/search/Dockerfile
    ports:
      - '3000:3000'
    environment:
      NODE_ENV: development
    volumes:
      - ../..:/workspace:rw
    working_dir: /workspace
    command: [ 'pnpm', 'dev', '--filter=search' ]
    healthcheck:
      test: [ 'CMD', 'wget', '--spider', '-q', 'http://localhost:3000/health' ]
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 20s

  indexer:
    build:
      context: ../..
      dockerfile: apps/backend/indexer/Dockerfile
    ports:
      - '3001:3001'
    environment:
      NODE_ENV: development
    volumes:
      - ../..:/workspace:rw
    working_dir: /workspace
    command: [ 'pnpm', 'dev', '--filter=indexer' ]
    healthcheck:
      test: [ 'CMD', 'wget', '--spider', '-q', 'http://localhost:3001/health' ]
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 20s
    depends_on:
      - search

  frontend:
    build:
      context: ../..
      dockerfile: apps/frontend/Dockerfile
    ports:
      - '5173:5173'
    environment:
      NODE_ENV: development
    volumes:
      - ../..:/workspace:rw
    working_dir: /workspace
    command: [ 'pnpm', 'dev', '--filter=frontend' ]
    depends_on:
      - search

  ui:
    build:
      context: ../..
      dockerfile: packages/ui/Dockerfile
    ports:
      - '8000:8000'
    environment:
      NODE_ENV: development
    volumes:
      - ../..:/workspace:rw
    working_dir: /workspace
    command: [ 'pnpm', 'dev', '--filter=chat-component' ]
    depends_on:
      - search

networks:
  default:
    name: apexcoach-ai-dev
